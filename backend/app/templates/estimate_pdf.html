<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ estimate.name }}</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 20px;
      color: #333;
    }

    h1 {
      text-align: center;
      font-size: 24px;
      margin-bottom: 20px;
    }

    p {
      margin: 5px 0;
      font-size: 16px;
    }

    .details {
      margin-bottom: 20px;
    }

    .details p {
      font-size: 16px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }

    th {
      background-color: #f7f7f7;
      font-weight: bold;
    }

    tfoot td {
      font-weight: bold;
    }

    .summary {
      margin-top: 20px;
      font-size: 14px;
    }

    .summary p {
      margin: 5px 0;
    }
  </style>
</head>

<body>
  <h1>{{ estimate.name }}</h1>

  <div class="details">
    {%if estimate.client %}
    <p><strong>Клиент:</strong> {{ estimate.client.name }}</p>
    <p><strong>Компания клиента:</strong> {{ estimate.client.company }}</p>
    <p><strong>Контакт клиента:</strong> {{ estimate.client.email }}</p>
    {% endif %}
    {% set labels =
    {'draft':'Черновик','sent':'Отправлена','approved':'Согласована','paid':'Оплачена','cancelled':'Отменена'}
    %}
    <p><strong>Статус:</strong> {{ labels[estimate.status.value] }}</p>
    <p><strong>Ответственный:</strong> {{ estimate.responsible }}</p>
    {% if estimate.event_datetime %}
    <p><strong>Дата и время мероприятия:</strong> {{ estimate.event_datetime }}</p>
    {% endif %}
    {% if estimate.event_place %}
    <p><strong>Место проведения мероприятия:</strong> {{ estimate.event_place }}</p>
    {% endif %}
    <p><strong>НДС:</strong>
      {% if estimate.vat_enabled %}
      {{ estimate.vat_rate }}%
      {% else %}
      -
      {% endif %}
    </p>
    <p><strong>Дата создания:</strong> {{ estimate.date.strftime('%d.%m.%Y %H:%M') }}</p>

  </div>

  <h1>Услуги</h1>

  {% set grouped = {} %}
  {% for item in estimate.items %}
  {% set _ = grouped.setdefault(item.category or 'Без категории', []).append(item) %}
  {% endfor %}

  {% for category, items in grouped.items() %}
  <h2 style="margin-top: 30px; font-size: 16px; color: #444;">{{ category }}</h2>
  <table>
    <thead>
      <tr>
        <th>Услуга</th>
        <th>Описание</th>
        <th>Кол-во</th>
        <th>Ед.</th>
        {% if estimate.use_internal_price %}
        <th>Внутр. цена</th>
        <th>Итог (внутр.)</th>
        {% endif %}
        <th>Внеш. цена</th>
        <th>Итог (внешн.)</th>
      </tr>
    </thead>
    <tbody>
      {% for item in items %}

      <tr>
        <td>{{ item.name }}</td>
        <td>{{ item.description or '' }}</td>
        <td>{{ item.quantity }}</td>
        <td>{{ item.unit }}</td>
        {% if estimate.use_internal_price %}
        <td>{{ "%.2f"|format(item.internal_price or 0) }}</td>
        <td>{{ "%.2f"|format((item.quantity or 0) * (item.internal_price or 0)) }}</td>
        {% endif %}
        <td>{{ "%.2f"|format(item.external_price or 0) }}</td>
        <td>{{ "%.2f"|format((item.quantity or 0) * (item.external_price or 0)) }}</td>
      </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        {% if estimate.use_internal_price %}
        <td colspan="5" style="text-align: right;">Итог по категории (внутр.):</td>
        <td>
          {% set ns = namespace(total_internal=0) %}
          {% for item in items %}
          {% set ns.total_internal = ns.total_internal + (item.quantity or 0) * (item.internal_price or 0) %}
          {% endfor %}
          {{ "%.2f"|format(ns.total_internal) }}
        </td>
        {% else %}
        <td colspan="3"></td>
        {% endif %}
        <td style="text-align: right;">Итог по категории (внешн.):</td>
        <td>
          {% set ns2 = namespace(total_external=0) %}
          {% for item in items %}
          {% set ns2.total_external = ns2.total_external + (item.quantity or 0) * (item.external_price or 0) %}
          {% endfor %}
          {{ "%.2f"|format(ns2.total_external) }}
        </td>
      </tr>
    </tfoot>
  </table>

  {% endfor %}

  <div class="details" style="margin-top: 30px; text-align: right">
    {% if estimate.use_internal_price %}
    <p><strong>Себестоимость:</strong> {{ "%.2f"|format(total_internal) }} ₽</p>
    {% endif %}
    <p><strong>Продажная стоимость:</strong> {{ "%.2f"|format(total_external) }} ₽</p>
    {% if estimate.use_internal_price %}
    <p><strong>Маржа:</strong> {{ "%.2f"|format(total_diff) }} ₽</p>
    {% endif %}
    {% if estimate.vat_enabled %}
    <p><strong>НДС ({{ estimate.vat_rate }}%):</strong> {{ "%.2f"|format(vat) }} ₽</p>
    <p><strong>Итого с НДС:</strong> {{ "%.2f"|format(total_with_vat) }} ₽</p>
    {% endif %}
  </div>

</body>

</html>